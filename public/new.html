<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Tomato Admin Pro</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#f8fafc] min-h-screen font-sans">
<div id="app" class="flex flex-col md:flex-row h-screen overflow-hidden">

  <aside class="w-full md:w-1/3 bg-white border-r flex flex-col h-1/2 md:h-full shadow-xl">
    <div class="p-6 border-b sticky top-0 bg-white z-10">
      <h1 class="text-2xl font-black text-blue-600 mb-4 flex items-center gap-2">üçÖ –ë–∞–∑–∞ –¢–æ–º–∞—Ç–æ–≤</h1>
      <input v-model="search" placeholder="üîç –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ..."
        class="w-full p-3 rounded-xl border-2 border-slate-100 focus:border-blue-500 outline-none transition-all">
    </div>

    <div class="flex-1 overflow-y-auto p-4 space-y-3">
      <div v-for="t in filtered" :key="t.id"
        class="p-4 border border-slate-100 rounded-2xl flex items-center gap-4 bg-white hover:shadow-md transition-all group">
        <img :src="t.image_url || 'https://via.placeholder.com/100'" class="w-12 h-12 rounded-lg object-cover bg-slate-100">
        <div class="flex-1 min-w-0">
          <div class="font-bold truncate text-slate-700">{{ t.title }}</div>
          <div class="text-[10px] text-blue-500 font-black uppercase">{{ t.category }}</div>
        </div>
        <button @click="remove(t.id)" class="p-2 text-red-300 hover:text-red-500 transition-colors text-xl">üóë</button>
      </div>
    </div>
  </aside>

  <main class="flex-1 overflow-y-auto p-4 md:p-10 flex justify-center items-start">
    <div class="w-full max-w-lg bg-white rounded-[2.5rem] p-8 shadow-2xl border border-white">
      <h2 class="text-3xl font-black mb-8 text-slate-800">–ù–æ–≤—ã–π —Å–æ—Ä—Ç</h2>

      <form @submit.prevent="save" class="space-y-6">
        <div>
          <label class="text-xs font-bold text-slate-400 uppercase ml-2">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input v-model="form.title" required placeholder="–ù–∞–ø—Ä: –°–µ—Ä–∂–∞–Ω—Ç –ü–µ–ø–ø–µ—Ä"
            class="w-full mt-1 p-4 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-blue-500 focus:bg-white outline-none text-lg transition-all">
        </div>

        <div>
          <label class="text-xs font-bold text-slate-400 uppercase ml-2">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <select v-model="form.category" class="w-full mt-1 p-4 rounded-2xl bg-slate-50 border-2 border-transparent outline-none cursor-pointer">
            <option value="Dwarf">–ì–Ω–æ–º (Dwarf)</option>
            <option value="Det">–ù–∏–∑–∫–∏–π (Det)</option>
            <option value="Indet">–í—ã—Å–æ–∫–∏–π (Indet)</option>
          </select>
        </div>

        <div>
          <label class="text-xs font-bold text-slate-400 uppercase ml-2">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è</label>
          <div class="mt-1 border-2 border-dashed border-slate-200 p-8 rounded-[2rem] text-center bg-slate-50 relative overflow-hidden group">
            <input type="file" @change="pickImage" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-10">
            <div v-if="!preview" class="text-slate-400 text-sm">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</div>
            <img v-if="preview" :src="preview" class="absolute inset-0 w-full h-full object-cover group-hover:opacity-50 transition-opacity">
          </div>
        </div>

        <button :disabled="loading"
          class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 text-white py-5 rounded-[1.5rem] text-xl font-bold shadow-xl shadow-blue-100 transition-all active:scale-95">
          {{ loading ? '‚è≥ –°–û–•–†–ê–ù–ï–ù–ò–ï...' : 'üíæ –î–û–ë–ê–í–ò–¢–¨ –í –ë–ê–ó–£' }}
        </button>
      </form>
    </div>
  </main>
</div>

<script>
// --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
const SUPABASE_URL = '–¢–í–û–ô_PROJECT_URL';
const SUPABASE_KEY = '–¢–í–û–ô_ANON_KEY';
const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

const { createApp } = Vue;
createApp({
  data() {
    return {
      tomatoes: [], search: '', loading: false,
      preview: '', file: null,
      form: { title: '', category: 'Dwarf' }
    };
  },
  computed: {
    filtered() {
      return this.tomatoes.filter(t => t.title.toLowerCase().includes(this.search.toLowerCase()));
    }
  },
  methods: {
    async load() {
      const { data } = await sb.from('tomatoes').select('*').order('created_at', { ascending: false });
      this.tomatoes = data || [];
    },
    pickImage(e) {
      const f = e.target.files[0]; if (!f) return;
      this.file = f;
      this.preview = URL.createObjectURL(f);
    },
    async save() {
      if (!this.form.title || this.loading) return;
      this.loading = true;

      try {
        let imageUrl = '';
        // 1. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ, –µ—Å–ª–∏ –æ–Ω–æ –≤—ã–±—Ä–∞–Ω–æ
        if (this.file) {
          const fName = `${Date.now()}_${this.file.name}`;
          // –í–∞–∂–Ω–æ: —Å–æ–∑–¥–∞–π Bucket —Å –∏–º–µ–Ω–µ–º 'tomatoes' –≤ –ø–∞–Ω–µ–ª–∏ Supabase Storage (Public)
          const { data: upData } = await sb.storage.from('tomatoes').upload(fName, this.file);
          if (upData) {
            const { data: urlData } = sb.storage.from('tomatoes').getPublicUrl(fName);
            imageUrl = urlData.publicUrl;
          }
        }

        // 2. –ó–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É
        const { error } = await sb.from('tomatoes').insert([
          { title: this.form.title, category: this.form.category, image_url: imageUrl }
        ]);

        if (!error) {
          this.form.title = ''; this.preview = ''; this.file = null;
          await this.load(); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ
        }
      } catch (e) {
        alert("–û—à–∏–±–∫–∞!");
      } finally {
        this.loading = false;
      }
    },
    async remove(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞?')) return;
      await sb.from('tomatoes').delete().eq('id', id);
      this.tomatoes = this.tomatoes.filter(t => t.id !== id);
    }
  },
  mounted() { this.load(); }
}).mount('#app');
</script>
</body>
</html>
